# LLM Instructions for Strings App

## About This Document

**PURPOSE**: Comprehensive reference guide for LLM agents working on the Strings application. Contains architecture, functionality, and implementation patterns for maintaining consistency.

**MAINTENANCE**: Keep updated with changes. Essential for future development work.

---

## Application Overview

**Application Name**: Strings  
**Purpose**: Web application for managing dynamic text content with a file-system-like structure where every string is a variable that can be referenced hierarchically.

### Core Concept: File System Analogy

- **Strings = Files**: Each string has content and a unique name/hash, can be referenced
- **Conditionals = Directories**: Containers holding multiple related string "files" (spawns)  
- **Variable References = File Includes**: Strings embed other strings using `{{variableName}}` syntax
- **Cascading Drawers = Deep Navigation**: Click nested variables to drill down with stacked editors

### Example Usage

Conditional variable `{{color-option}}` with spawns `{{option-1}}` (content: "blue") and `{{option-2}}` (content: "green").

String: "My favorite color is `{{color-option}}`"
- If option-1 selected â†’ "My favorite color is blue"
- If option-2 selected â†’ "My favorite color is green"

### Key Features

- **Every String is a Variable**: Automatic variable creation with slugified names or 6-character hash
- **Variable Embedding**: Recursive `{{variableName}}` references with circular protection
- **Conditionals**: Convert strings to directories containing multiple variations (spawns)
- **Spawn Selection**: Users select which spawn variable displays for each conditional variable
- **Controlling Conditions**: Spawn variables can auto-select based on other spawn selections
- **Drawer Navigation System**: Visual hierarchy sidebar showing parents, current variable, and children with click-to-navigate
- **Canvas Display Control**: Hide embedded strings, toggle variable names/hashes, plaintext mode
- **Conditions-Only Sidebar**: Conditional variables managed exclusively in left sidebar, not shown in canvas
- **Real-time Variable Detection**: Sparkles icon (âœ¨) for new/pending variables
- **Unified Variable Hash Badges**: Click-to-copy badges with gradient backgrounds indicating variable type
- **Minimal UI**: Clean cards with shadow effects, no redundant type icons or badges

---

## Architecture

### Frontend (Next.js 14)
- **Location**: `/frontend/`
- **Framework**: Next.js 14 with App Router, Tailwind CSS, ShadCN/UI
- **State**: React useState/useEffect, cookie-based auth
- **Pattern**: Null-safe operations (`project?.strings`)
- **Development Server**: `npm run dev` (from frontend directory)

### Backend (Django)
- **Location**: `/backend/`  
- **Framework**: Django with DRF, SQLite, session auth
- **Pattern**: Comprehensive validation with meaningful errors
- **Development Server**: 
  ```bash
  source backend/env/bin/activate
  python backend/manage.py runserver
  ```

---

## Data Models

### Core Models

1. **Project**: Container for all content (name, description, user)

2. **String**: The "file" system - every string is automatically a variable
   - **Fields**: content, project, display_name, variable_name (auto-generated), variable_hash (auto-fallback), is_conditional, is_conditional_container, controlled_by_spawn
   - **Display Name**: Human-readable name (e.g., "Welcome Message")
   - **Variable Name**: Auto-generated slug from display_name (e.g., "welcome-message") or random hash if no display_name
   - **Variable Hash**: 6-character fallback identifier (e.g., "A7B2K9")
   - **Effective Variable Name**: Returns variable_name || variable_hash
   - **Conditional Variables**: Containers that hold multiple spawn variables
   - **Spawn Variables**: Individual variations within a conditional variable
   - **Controlled By Spawn**: Optional ForeignKey to another spawn variable that controls this spawn's selection

3. **Dimension** (Deprecated): Previously used to link conditional variables to spawn options
   - Model still exists in database for data compatibility
   - No longer actively managed or used by frontend/backend
   - API endpoints removed

4. **DimensionValue** (Deprecated): Previously held individual spawn options
   - Model still exists in database for data compatibility
   - No longer actively managed or used by frontend/backend
   - API endpoints removed

### Key Relationships
- Strings reference other strings via `{{variableName}}` embedding
- Conditional variables contain spawn variables (multiple string variations)
- Spawn selection determines which content displays for conditional variables
- Controlling spawn relationships enable cascading auto-selection
- Circular reference protection prevents infinite loops

---

## User Interface

### Layout (Three Panels)

**Left - Conditions Sidebar (360px)**:
- Conditional variables with display names
- Spawn variables as selectable tags beneath each conditional
- Hover-triggered edit pencil icons
- Selected spawns: Blue background
- Auto-selected spawns: Green background with "(auto)" label
- Disabled/locked spawns: Grey with "(locked)" label

**Center - Main Canvas**:
- String variables only (conditionals excluded - managed in sidebar)
- Purple badges for strings
- Canvas Settings button opens right-hand drawer
- New String button for creating variables

**Right - Variables Sidebar** (collapsible): Variable management

### Canvas Settings Drawer

**Display Mode Section**:
- **Plaintext Mode**: Show resolved content without styling or conditional variables
- **Show Variables**: Display variable names as badges instead of resolved content  
- **Hide Embedded Strings** (ON by default): Hide strings used as variables or spawn variables
- **Show Variable Names** (ON by default): Display the variable name (title/display_name) on each string card
- **Show Variable Hashes** (OFF by default): Display the copiable variable hash badge on each string card

**Key Features**:
- Real-time updates: Canvas updates instantly
- Smart detection: Automatically identifies embedded strings
- Conditional variables always hidden from canvas (managed in Conditions sidebar)

### Unified Drawer System

**Single Component Architecture**:
- `StringEditDrawer` component handles all string/conditional editing
- `useStringEditDrawer` hook manages all drawer state and operations
- `stringOperations.ts` contains consolidated save logic
- Replaces 4+ legacy drawer systems
- 60% code reduction, consistent UX across all scenarios

**Drawer Navigation Sidebar (Mini-Nav)**:
- Fixed 120px width with 16px horizontal padding to accommodate full tree layout
- Visual hierarchy showing variable relationships with branching tree connectors
- **Parents** (36px, left of vertical line): Variables that embed or spawn the current one
  - Horizontal connectors from parent's right edge to vertical line
- **Current** (48px, centered): Active variable being edited
  - Vertical line descends from center-bottom to children, ascends from center-top to parents
- **Children** (36px, right of vertical line): Spawns, embedded, and pending variables
  - Horizontal connectors from vertical line to child's left edge
- All tiles have 1px border stroke (consistent for active and inactive)
- Click any square to navigate to that variable
- Hover tooltips show full names and relationships
- Color-coded: Teal for strings (`--string-var-color`), Orange for conditionals (`--conditional-var-color`)
- Works for both creating new and editing existing variables
- Immediate save (no batch operations)

**Three Main Tabs**: Content, Conditions, Advanced

**Content Tab**:
- Variable Type dropdown: String or Conditional
- **String Mode**: Text content editing (child variables shown in navigation sidebar)
- **Conditional Mode**: "Include option to hide" toggle (spawn variables shown in navigation sidebar)

**Conditions Tab**:
- Shows parent conditional variables (for spawn variables)
- **Controlling Condition Feature**:
  - Toggle to enable/disable
  - Dropdown to select controller spawn
  - Grouped list by parent conditional
  - Type-ahead search filtering (searches ID/hash AND content)
  - Content preview shown below each spawn option (resolved to plaintext, truncated to 60 chars)
  - Auto-selection when controller is selected

**Advanced Tab**:
- Display Name input (triggers slugify)
- Variable Name (read-only, auto-generated)
- Variable Hash (read-only, fallback)

### Spawn Management

**Add/Remove Spawns**:
- Add New Spawn button (creates temporary spawn)
- Add Existing Variable as Spawn (autocomplete search)
- Remove spawn button (hover-triggered in navigation or via conditions sidebar)
- Include Hide Option checkbox

**Navigation**:
- All spawn variables shown in drawer navigation sidebar
- Click spawn square to navigate and edit
- Spawns aligned to right side of navigation

---

## API Endpoints

### Authentication
- `POST /api/auth/login/` - Login
- `POST /api/auth/logout/` - Logout  
- `POST /api/auth/register/` - Register
- `GET /api/auth/me/` - Current user

### Projects
- `GET /api/projects/` - List projects (ordered by -created_at)
- `POST /api/projects/` - Create project
- `GET /api/projects/{id}/` - Get project with all data
- `PATCH /api/projects/{id}/` - Update project
- `DELETE /api/projects/{id}/` - Delete project
- `POST /api/projects/{id}/duplicate/` - Duplicate project with all content

### Strings (Core API)
- `POST /api/strings/` - Create string (auto-generates variable_name from display_name using slugify)
- `PATCH /api/strings/{id}/` - Update string (auto-updates variable_name if display_name changes)
- `DELETE /api/strings/{id}/` - Delete string
- `POST /api/strings/{id}/duplicate/` - Duplicate string (preserves embedded variable references)

**String Creation/Update Payload**:
```json
{
  "content": "String content here",
  "display_name": "Welcome Message",  // Optional - generates slug: "welcome-message"
  "is_conditional": false,
  "is_conditional_container": false,
  "controlled_by_spawn_id": null,  // Optional - ID of controlling spawn variable
  "project": 1
}
// Note: variable_name is auto-generated (read-only) from display_name
// If no display_name provided, uses random 6-char hash
```

### Dimensions (Removed)
- Dimension API endpoints have been removed from the backend
- `/api/dimensions/`, `/api/dimension-values/`, `/api/string-dimension-values/` no longer exist
- Frontend works directly with conditional/spawn variables via the String API
- Dimension models still exist in database for data compatibility but are no longer actively managed

---

## Key Implementation Patterns

### State Management
```javascript
// Null-safe data access
const strings = project?.strings || [];

// Conditional spawn selection state (NEW - replaces dimension-based state)
const [selectedConditionalSpawns, setSelectedConditionalSpawns] = useState<{
  [conditionalVariableName: string]: string | null
}>({});

// Canvas display settings
const [hideEmbeddedStrings, setHideEmbeddedStrings] = useState(true);
const [showVariableNames, setShowVariableNames] = useState(true);
const [showVariableHashes, setShowVariableHashes] = useState(false);

// Unified drawer system
const mainDrawer = useStringEditDrawer({
  project,
  selectedDimensionValues,
  pendingStringVariables,
  onSuccess: () => fetchProject()
});
```

### Conditional Variable Resolution
```javascript
// Direct conditional spawn selection (NEW)
const selectedSpawnName = selectedConditionalSpawns[conditionalName];

// Find and render spawn content
if (selectedSpawnName && selectedSpawnName !== "Hidden") {
  const spawnVariable = project?.strings?.find((str: any) =>
    str.effective_variable_name === selectedSpawnName ||
    str.variable_name === selectedSpawnName ||
    str.variable_hash === selectedSpawnName
  );
  
  if (spawnVariable) {
    const spawnContent = processConditionalVariables(spawnVariable.content || '');
    processedContent = processedContent.replace(regex, spawnContent);
  }
}
```

### Slugify-Based Variable Naming
```python
# Backend: String model save() method
def save(self, *args, **kwargs):
    if self.display_name and self.display_name.strip():
        base_slug = slugify(self.display_name, max_length=50)
        self.variable_name = self.generate_unique_slug(base_slug)
    elif not self.variable_name:
        self.variable_name = self.generate_unique_hash()
    
    if not self.variable_hash:
        self.variable_hash = self.generate_unique_hash()
    
    super().save(*args, **kwargs)
```

### Controlling Spawn Relationships
```javascript
// Build bidirectional maps
const getControllingSpawnMap = () => {
  const controllerToControlled = new Map<number, number[]>();
  const controlledToController = new Map<number, number>();
  
  project.strings.forEach((str: any) => {
    if (str.controlled_by_spawn_id) {
      controlledToController.set(str.id, str.controlled_by_spawn_id);
      if (!controllerToControlled.has(str.controlled_by_spawn_id)) {
        controllerToControlled.set(str.controlled_by_spawn_id, []);
      }
      controllerToControlled.get(str.controlled_by_spawn_id)!.push(str.id);
    }
  });
  
  return { controllerToControlled, controlledToController };
};

// Auto-select controlled spawns when controller is selected
useEffect(() => {
  // ... build autoSelections map ...
  
  // Only update if there are actual changes (prevents infinite loop)
  if (Object.keys(autoSelections).length > 0) {
    const hasChanges = Object.entries(autoSelections).some(
      ([conditionalName, spawnName]) => 
        selectedConditionalSpawns[conditionalName] !== spawnName
    );
    
    if (hasChanges) {
      setSelectedConditionalSpawns(prev => ({ ...prev, ...autoSelections }));
    }
  }
}, [selectedConditionalSpawns, project?.strings]);
```

### Inline Spawn Editing
```typescript
// Component: StringEditDrawer.tsx
<Input
  value={spawn.display_name || ''}
  onChange={(e) => onUpdateSpawn?.(index, { ...spawn, display_name: e.target.value })}
  placeholder="Enter variable name"
/>

<Textarea
  value={spawn.content || ''}
  onChange={(e) => onUpdateSpawn?.(index, { ...spawn, content: e.target.value })}
  placeholder="Enter spawn content"
  rows={3}
/>

// Hook: useStringEditDrawer.ts
const updateSpawn = useCallback((index: number, updatedSpawn: any) => {
  setState(prev => ({
    ...prev,
    conditionalSpawns: prev.conditionalSpawns.map((spawn, i) => 
      i === index ? updatedSpawn : spawn
    )
  }));
}, []);

// Save logic: stringOperations.ts
const spawnPayload = {
  content: spawn.content?.trim() || 'Default spawn content',
  display_name: spawn.display_name?.trim() || null,  // Triggers slugify
  is_conditional: false,
  is_conditional_container: false,
  project: projectId,
};
```

### Inline Embedded Variable Editing
```typescript
// State management in useStringEditDrawer.ts
embeddedVariableEdits: {[variableId: string]: {display_name?: string; content?: string}};
pendingVariableContent: {[variableName: string]: string};

// Component: StringEditDrawer.tsx - Existing variables
const currentEdits = embeddedVariableEdits[stringVar.id] || {};
const currentDisplayName = currentEdits.display_name !== undefined 
  ? currentEdits.display_name 
  : (stringVar.display_name || '');

<Input
  value={currentDisplayName}
  onChange={(e) => {
    const newEdits = {
      ...embeddedVariableEdits,
      [stringVar.id]: { ...currentEdits, display_name: e.target.value }
    };
    onEmbeddedVariableEditsChange(newEdits);
  }}
/>

// Component: StringEditDrawer.tsx - Pending variables
<Textarea
  value={pendingVariableContent[variableName] || ''}
  onChange={(e) => {
    const newContent = { ...pendingVariableContent, [variableName]: e.target.value };
    onPendingVariableContentChange(newContent);
  }}
  placeholder="Enter content or leave blank for default"
/>

// Save logic: useStringEditDrawer.ts
const saveEmbeddedVariableEdits = async () => {
  for (const [variableId, edits] of Object.entries(state.embeddedVariableEdits)) {
    const payload: any = {};
    if (edits.display_name !== undefined) payload.display_name = edits.display_name?.trim() || null;
    if (edits.content !== undefined) payload.content = edits.content?.trim() || 'Default content';
    await apiFetch(`/api/strings/${variableId}/`, { method: 'PATCH', body: JSON.stringify(payload) });
  }
};

// Custom content for new variables
const customContent = state.pendingVariableContent[varName];
const content = customContent && customContent.trim() 
  ? customContent.trim() 
  : `Content for ${varName}`;
```

### Nested Variable Prevention
```typescript
// Validation in save function (useStringEditDrawer.ts)
// Check spawn content
for (const spawn of state.conditionalSpawns) {
  if (spawn.content && spawn.content.includes('{{')) {
    throw new Error(
      `Spawn variable "${spawn.display_name || 'Unnamed'}" contains embedded variables ({{...}}). ` +
      `Nested variables cannot be added in this view. Please open the variable directly.`
    );
  }
}

// Check embedded variable edits
for (const [variableId, edits] of Object.entries(state.embeddedVariableEdits)) {
  if (edits.content && edits.content.includes('{{')) {
    throw new Error(
      `Embedded variable "${varName}" contains nested variables ({{...}}). ` +
      `Please open the variable directly to add embedded variables.`
    );
  }
}

// Check pending variable content
for (const [varName, content] of Object.entries(state.pendingVariableContent)) {
  if (content && content.includes('{{')) {
    throw new Error(
      `New variable "${varName}" contains embedded variables ({{...}}). ` +
      `Please open the variable directly after creation.`
    );
  }
}
```

### Error Handling
```javascript
// Graceful handling of API errors
try {
  await apiFetch(`/api/strings/${stringId}/`, {
    method: 'DELETE',
  });
} catch (deleteError: any) {
  const errorStr = deleteError.message || String(deleteError);
  if (errorStr.includes('Not found') || errorStr.includes('404')) {
    console.log(`Already removed, continuing...`);
  } else {
    console.error(`Failed to delete:`, deleteError);
    // Optionally re-throw for critical operations
  }
}
```

---

## Major Architectural Changes

### Dimensions Elimination (January 2025)

**Previous Architecture**:
```
User sees: "Dimensions" â†’ "Dimension Values"
Backend:   Conditional Variable â†’ Dimension â†’ Dimension Values â†’ Spawn Variables
Frontend:  selectedDimensionValues[dimensionId] = dimensionValueName
```

**New Architecture**:
```
User sees: Conditional Variables â†’ Spawn Variables (direct)
Backend:   Conditional Variable â†’ Spawn Variables (no dimension layer)
Frontend:  selectedConditionalSpawns[conditionalName] = spawnName
```

**Key Changes**:
- Conditions sidebar shows actual conditional/spawn variable names
- Direct spawn selection without dimension ID lookups
- Dimension API endpoints removed from backend
- Backend dimension signals and helper methods removed
- Frontend dimension-related API calls removed from `stringOperations.ts`
- Dimension models remain in database for data preservation

**Benefits**:
- Simplified mental model (what you see = actual data structure)
- Reduced complexity (eliminated abstraction layer)
- Better performance (direct name lookups)
- Clearer UI ("Conditions" instead of "Dimensions")
- Smaller codebase (removed dimension ViewSets, serializers, signals)

### Unified Drawer System (January 2025)

**Consolidated**:
- 4+ duplicate drawer systems â†’ Single `StringEditDrawer` component
- Multiple save functions â†’ Single `saveString` function in `stringOperations.ts`
- Inconsistent interfaces â†’ Unified 3-tab structure (Content, Conditions, Advanced)

**Results**:
- 60% code reduction
- Consistent UX across all editing scenarios
- Easier maintenance and debugging
- Single source of truth for drawer logic

---

## Working Features

### Core Functionality
- âœ… Authentication system with Django sessions
- âœ… Project management with CRUD operations
- âœ… String-as-variable system with auto-slugify generation
- âœ… Variable embedding with recursive processing
- âœ… Conditional system with spawn management
- âœ… Controlling condition relationships
- âœ… Inline spawn editing
- âœ… Inline embedded variable editing
- âœ… Custom content for new variables
- âœ… Nested variable prevention validation
- âœ… Circular reference protection
- âœ… Canvas display control (hide embedded, toggle names/hashes)

### UI/UX
- âœ… Three-panel responsive layout (Conditions sidebar, Canvas, Variables sidebar)
- âœ… Unified drawer system for all editing
- âœ… Canvas Settings drawer with display options
- âœ… Conditions sidebar with spawn selection (conditionals excluded from canvas)
- âœ… Yellow/purple/orange variable detection boxes
- âœ… Bulk operations with floating action bar
- âœ… String duplication preserving variable references
- âœ… Grand Hotel font for logo

### Technical
- âœ… Idempotent operations throughout
- âœ… Comprehensive content validation (including nested variable prevention)
- âœ… Django signals for variable name tracking
- âœ… Frontend/backend validation alignment
- âœ… Slugify-based variable naming
- âœ… Local state management for inline editing
- âœ… Graceful error handling for race conditions
- âœ… Dimension layer removed (simplified architecture)

---

## Testing Focus Areas

### Critical Flows
1. **Inline Embedded Variable Editing**: Edit embedded variable names/content â†’ save parent â†’ verify slugify â†’ check updates
2. **Custom Content for New Variables**: Add new variable with custom content â†’ save â†’ verify content persists
3. **Nested Variable Prevention**: Try adding `{{var}}` in spawn/embedded content â†’ verify validation blocks it
4. **Inline Spawn Editing**: Edit spawn names/content â†’ save â†’ verify slugify â†’ check conditions sidebar updates
5. **Controlling Conditions**: Set controller â†’ select controller spawn â†’ verify auto-selection and disabled states
6. **Variable Embedding**: Multi-level Aâ†’Bâ†’C references work correctly
7. **Circular Protection**: Self-reference and loops properly blocked
8. **Canvas Filtering**: Hide embedded strings, toggle names/hashes, plaintext mode
9. **Hidden Option Toggle**: Enable/disable "Hidden" option for conditional variables â†’ verify no "Not found" errors

### UI/UX
1. **Drawer System**: Unified drawer handles create/edit for strings and conditionals
2. **Embedded Variables Section**: Shows existing (purple/orange) and new (yellow) variables with inline editing
3. **Conditions Sidebar**: Spawn selection, auto-selection, disabled states display correctly
4. **Canvas**: Only shows string variables (conditionals excluded)
5. **Variable Boxes**: Yellow (new), purple (existing strings), orange (conditionals) appear correctly
6. **Canvas Settings**: All toggles work together properly

---

## Development Workflow

### Git Operations
- **IMPORTANT**: Do NOT commit or push code changes unless explicitly requested by the user
- Only make the requested code changes and let the user handle git operations when ready
- User prefers to control their own commit timing and messages

### Development Servers
**Auto-Start Configuration**: The project has `.vscode/tasks.json` configured to automatically start both servers when the workspace opens:
- **Backend Server**: Green terminal, server icon, runs `python manage.py runserver` (port 8000)
- **Frontend Server**: Blue terminal, browser icon, runs `npm run dev` (port 3000)

**Manual Start**: If servers need to be restarted manually:
- **Start each server in a separate Cursor/VS Code terminal window**
- **Backend**: `cd backend && source env/bin/activate && python manage.py runserver`
- **Frontend**: `cd frontend && npm run dev`
- Run each as a background process so they persist

**VS Code Tasks Available**:
- "Backend Server" - Starts Django backend
- "Frontend Server" - Starts Next.js frontend  
- "Start All Servers" - Starts both together
- Access via `Cmd+Shift+P` â†’ "Tasks: Run Task"

### File Structure
```
frontend/src/
â”œâ”€â”€ components/
â”‚   â””â”€â”€ StringEditDrawer.tsx          # Unified drawer component
â”œâ”€â”€ hooks/
â”‚   â””â”€â”€ useStringEditDrawer.ts        # Unified state management
â”œâ”€â”€ lib/
â”‚   â””â”€â”€ stringOperations.ts           # Consolidated save logic
â””â”€â”€ app/(dashboard)/projects/[id]/
    â””â”€â”€ page.tsx                      # Main project page
```

### Key Files
- **`page.tsx`**: Main UI, conditions sidebar, canvas, state management
- **`StringEditDrawer.tsx`**: Unified drawer for all editing scenarios
- **`DrawerNavigation.tsx`**: Visual hierarchy sidebar for variable relationships
- **`VariableHashBadge.tsx`**: Reusable hash badge component with copy-to-clipboard
- **`useStringEditDrawer.ts`**: Drawer state and operations
- **`stringOperations.ts`**: Save logic for strings and conditionals
- **`backend/strings_api/models.py`**: String model with slugify logic
- **`backend/strings_api/serializers.py`**: API serializers
- **`frontend/src/styles/embedded-variables.scss`**: Centralized styling for embedded variables and hash badges
- **`frontend/src/components/ui/tooltip.tsx`**: ShadCN/UI tooltip component
- **`frontend/src/components/ui/sheet.tsx`**: ShadCN/UI sheet component (modified for wider drawer)

---

## Embedded Variable Styling System

### Overview
All embedded variable styling is centralized in a single SCSS file for easy customization. The system uses semantic naming (based on what the element is, not how it looks) and progressive tinting for nested variables of the same type.

### File Location
- **`frontend/src/styles/embedded-variables.scss`**: All embedded variable styles
- **`frontend/src/styles/README.md`**: Customization guide

### Color Variables (Customizable)
```scss
// Edit these to change the entire color scheme
$string-var-color: blue;              // Border color for string variables
$string-text-color: black;            // Text color for string variables
$conditional-var-color: gold;         // Border color for conditional variables
$conditional-text-color: black;       // Text color for conditional variables
```

### Semantic Class Names
- **String Variables**: `.embedded-var-string-{0-4}` (not color-based like "purple")
- **Conditional Variables**: `.embedded-var-conditional-{0-4}` (not color-based like "orange")
- **Badge Mode**: `.embedded-var-badge-string`, `.embedded-var-badge-conditional`

### DRY Architecture
Uses attribute selectors to apply base styles to all depth levels:
```scss
// Base styles for ALL string variables
[class*="embedded-var-string-"] {
  color: $string-text-color;
  border-color: $string-var-color;
  padding: 0 0 4px;
}

// Only depth-specific hover backgrounds
.embedded-var-string-0:hover { background-color: tint($string-var-color, 70%); }
.embedded-var-string-1:hover { background-color: tint($string-var-color, 60%); }
// ... etc
```

### Progressive Hover Tinting
- **Depth 0**: `tint(70%)` - Very light (70% white mixed in)
- **Depth 1**: `tint(60%)` - Slightly darker
- **Depth 2**: `tint(50%)` - Medium
- **Depth 3**: `tint(40%)` - Darker
- **Depth 4**: `tint(30%)` - Darkest

### Tint/Shade Functions
Uses SCSS `mix()` function for solid colors (no transparency):
```scss
@function tint($color, $percentage) {
  @return mix(white, $color, $percentage);
}

@function shade($color, $percentage) {
  @return mix(black, $color, $percentage);
}
```

### Same-Type Nesting Logic
- **Color context tracking**: Tracks whether parent is 'string' or 'conditional'
- **Depth resets**: When variable type changes (stringâ†’conditional or vice versa), depth resets to 0
- **Progressive tinting**: Only applies when same type is nested within itself

**Example:**
```
Parent string (no color) >
  String var (depth 0, light hover) >
    Conditional var (depth 0, type changed!) >
      Conditional var (depth 1, darker hover) >
        String var (depth 0, type changed!) >
          String var (depth 1, darker hover)
```

### Border Behavior
- **Always base color**: Border color never changes, regardless of depth or hover state
- **Consistent identifier**: Acts as stable visual indicator of variable type

### TypeScript Integration
- Helper function: `getEmbeddedVarClass(type: 'string' | 'conditional', colorDepth: number)`
- Function signatures: `colorContext: 'string' | 'conditional' | null`
- Automatically applies correct class based on nesting context

---

## Recent Major Updates (2025)

### Dimension Layer Removal (Latest - January 2025)
- **Backend**: Removed dimension-related signals, helper methods, and API ViewSets
  - Removed `DimensionViewSet`, `DimensionValueViewSet`, `StringDimensionValueViewSet` from `views.py`
  - Removed router registrations for dimension endpoints from `urls.py`
  - Removed `update_dimension_values_from_variables()` method from `String` model
  - Removed dimension-related signals (`update_dependent_strings_when_string_variable_changes`, etc.)
  - Removed calls to dimension methods from `StringSerializer`
- **Frontend**: Removed dimension API calls from `stringOperations.ts`
  - Conditional variables now saved using only `is_conditional_container` flag
  - Spawn variables linked via `controlled_by_spawn_id` field
  - No more `/api/dimensions/`, `/api/dimension-values/` calls
- **Data Preservation**: Dimension models (`Dimension`, `DimensionValue`, `StringDimensionValue`) still exist in database for historical data

### Controlling Spawn Selector Enhancement (Latest - January 2025)
- **Content Preview**: Each spawn option in the controlling condition dropdown now shows a content preview
  - Content resolved to plaintext based on current conditional selections
  - Truncated to 60 characters with ellipsis for long content
- **Enhanced Search**: Type-ahead search now filters by both ID/hash AND content
  - Makes it easier to find correct spawn when many exist with similar names
  - Search matches on `display_name`, `effective_variable_name`, `variable_hash`, and `content`

### Drawer Navigation System
- **Visual Hierarchy Sidebar**: Shows parents, current variable, and children as clickable squares
- **Parent Detection**: Automatically finds variables that embed or spawn the current one
- **Child Display**: Shows spawns, embedded, and pending variables
- **Size Differentiation**: Active (48px centered), Parents/Children (36px)
- **Branching Tree Structure**: 
  - **Parents Section**: Vertical line descends from horizontal center of active tile's top; horizontal connectors branch LEFT from vertical line to each parent tile's right edge (at vertical center)
  - **Children Section**: Vertical line descends from horizontal center of active tile's bottom; horizontal connectors branch RIGHT from vertical line to each child tile's left edge (at vertical center)
- **Consistent Layout**: Mini-nav sidebar width (120px) accommodates full parent + active + child layout with 16px horizontal padding
- **1px Border Stroke**: All tiles (active and inactive) use 1px border for consistency
- **Click-to-Navigate**: Immediate navigation to any related variable
- **Hover Tooltips**: Fixed-position tooltips with variable names and relationships
- **Color-Coded**: Teal for strings, Orange for conditionals (uses CSS variables `--string-var-color` and `--conditional-var-color`)
- **Simplified Content Tab**: Removed inline editing sections (now handled via navigation)
- **Component Architecture**: Separate `NodeSquare` component with consistent sizing and styling

### Drawer UI Refinements
- **Unified Variable Hash Badges**: All variable hashes use `VariableHashBadge` component
  - Click-to-copy functionality throughout app
  - Gradient backgrounds: String variables (color â†’ gray), Conditional variables (color â†’ gray)
  - Type-aware styling via `type` prop ('string' | 'conditional' | 'default')
  - Centralized in SCSS with `$string-var-color` and `$conditional-var-color`
  - Border radius: 0.375rem (rounded-md) for consistency
- **Pending Variable Indicators**: Sparkles icon (âœ¨) with tooltip ("Pending/New") for new variables
  - Purple color (`$pending-var-color: mediumpurple`) in SCSS
  - Replaces "New variable!" and "Existing variable" badges
  - Standalone icon without box/border, size h-5 w-5
- **Minimal Card Design**: 
  - Removed all type indicator icons (Plus, Spool, Folder) from variable cards
  - Unified shadow-based cards: `shadow-sm hover:shadow-md transition-all`
  - Clean borders without background colors
  - Focus on content rather than visual noise
  - Consistent styling for embedded, spawn, and pending variable cards
- **Drawer Header Layout**: Variable hash badge positioned beneath title instead of side-by-side
- **Conditional Variable Editing**: Removed edit icons and messages for conditional variables in embedded/spawn lists
  - No misleading paths to edit conditionals from inline contexts
  - Conditional variables shown as read-only in inline contexts
- **Spawn Remove Button**: Neutral ghost button styling (no red coloring)
- **Tooltip Component**: Added ShadCN/UI tooltip component (`@radix-ui/react-tooltip`)
- **Conditions Sidebar Badge Refinements**:
  - All selected spawn badges use solid conditional color background (no gradient)
  - Text always neutral gray (rgb(55 65 81)) - never changes on hover or active state
  - Font weight: medium (500) - not bold
  - Border radius: 0.375rem (rounded-md) matching hash badges
  - Locked/controlled spawns: Lock icon (ðŸ”’) prefix + 60% opacity
  - Removed "(auto)" and "(locked)" text labels
  - Pencil edit icon always has cursor-pointer, even on disabled badges
  - Unselected badges stay neutral on hover (no color change)

### Embedded Variable Styling System
- **Centralized SCSS file**: All embedded variable styling consolidated into `frontend/src/styles/embedded-variables.scss`
- **Semantic naming**: Classes use `string`/`conditional` instead of color names (`purple`/`orange`)
- **DRY architecture**: Attribute selectors for base styles, depth classes only define hover backgrounds
- **Customizable colors**: Four variables at top of file control entire color scheme
- **Progressive hover tinting**: Uses SCSS `mix()` function for solid colors (no transparency)
- **Same-type nesting logic**: Color depth only increments when same type is nested within itself
- **Consistent borders**: Border color always uses base color, never changes on hover or with depth
- **Easy customization**: Change entire color scheme by editing 4 variables

### Inline Embedded Variable Editing (Latest)
- Edit existing embedded variables' names/content directly within parent string drawer
- Custom content input for new embedded variables (optional, defaults to "Content for {name}")
- Purple/orange tiles for existing variables, yellow tiles for new variables
- Local state management prevents React mutation issues
- Batch save: all embedded variable edits saved together with parent string
- Nested variable prevention: Validation blocks `{{...}}` in inline editing contexts

### Canvas Simplification
- Conditional variables removed from canvas (managed exclusively in Conditions sidebar)
- Canvas now shows string variables only
- Removed String Type Filter section from Canvas Settings
- Clearer separation: strings in canvas, conditionals in sidebar
- Improved performance with fewer items to render

### Font Update
- Logo font changed from Knewave to Grand Hotel
- Elegant cursive style for more artistic feel
- Google Fonts integration via Next.js font system

### Inline Spawn Editing Feature
- Edit spawn names and content directly within conditional variable drawer
- Variable Name input for all spawn types (triggers slugify)
- Content textarea for string variables only
- Conditional spawns show name + edit button
- Batch save: all spawn edits saved together
- Conditions sidebar automatically syncs with new slugified names

### Controlling Condition Feature
- Spawn variables can be controlled by other spawn variables
- When controller spawn is selected â†’ controlled spawn auto-selects
- Sibling spawns of controlled spawn become disabled
- Visual indicators: green "(auto)" for controlled, grey "(locked)" for disabled
- Edit icons still work on disabled spawns
- Prevents infinite loops with hasChanges check
- **Enhanced Spawn Selector** (Latest):
  - Content preview shown below each spawn option (resolved to plaintext using current conditional settings)
  - Content truncated to 60 characters with ellipsis
  - Type-ahead search filters by ID/hash AND content
  - Makes it easier to identify correct spawn when many exist

### Canvas Display Controls
- Hide Embedded Strings (ON by default)
- Show Variable Names (ON by default)
- Show Variable Hashes (OFF by default)
- Plaintext Mode toggle
- Show Variables toggle

### Slugify-Based Variable Naming
- Display names automatically converted to URL-friendly identifiers
- Backend uses python-slugify with uniqueness handling
- Fallback to random 6-char hash if no display name
- Frontend shows live preview of generated slug
- Conditions sidebar displays slugified names

### Dimensions Elimination (Complete)
- Frontend UI simplified to work directly with conditional/spawn variables
- Eliminated abstract "dimensions" layer from user interface
- Backend dimension API endpoints removed (`/api/dimensions/`, `/api/dimension-values/`, `/api/string-dimension-values/`)
- Backend dimension signals and helper methods removed from `models.py`
- Frontend dimension-related API calls removed from `stringOperations.ts`
- Dimension models remain in database for data preservation (no migration needed)
- Improved performance and clarity

---

## Implementation Guidelines

### String Variables
- Every string is automatically a variable (no opt-in)
- Purple badges for strings (conditionals not shown in canvas)
- Always show `{{effectiveVariableName}}` with copy functionality
- Canvas shows string variables only (conditionals managed in sidebar)
- Use Canvas Settings to hide embedded strings

### Variable Embedding
- Use `{{variableName}}` syntax only
- Max 10 levels depth with visited set tracking
- Process with current spawn selections
- Validate against circular references

### Unified Drawer System
- All editing uses `StringEditDrawer` component
- `useStringEditDrawer` manages all state and operations
- Variable Type dropdown for String/Conditional selection
- Auto-repair for missing `is_conditional_container` flags
- Consolidated save logic handles all scenarios

### Content Validation
- Multiple layers: Frontend + backend validation
- Default fallbacks: Never allow empty content
- Meaningful errors: Specific validation messages
- Idempotent operations: Safe to retry

### Error Handling
- Null safety: Use `project?.strings` patterns
- Graceful degradation: Fallbacks for missing data
- User feedback: Clear error messages via toast
- Race condition handling: Check for "Not found" errors when backend signals pre-empt frontend operations

---

**CORE PRINCIPLE**: This is a file system for text content. Every string is a file, conditionals are directories, and the unified drawer system enables consistent editing throughout the hierarchy. Maintain this analogy for intuitive user experience.
