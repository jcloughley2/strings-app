# LLM Instructions for Strings App

## About This Document

**PURPOSE**: Reference guide for LLM agents working on the Strings application. Contains architecture, functionality, and implementation patterns.

**MAINTENANCE**: Keep updated with significant changes. Essential for future development work.

---

## Application Overview

**Application Name**: Strings  
**Purpose**: Web application for managing dynamic text content with a file-system-like structure where every string is a variable that can be referenced hierarchically.

### Core Concept: File System Analogy

- **Strings = Files**: Each string has content and a unique hash identifier, can be referenced
- **Conditionals = Directories**: Containers holding multiple related string "files" (spawns)  
- **Variable References = File Includes**: Strings embed other strings using `{{variableHash}}` syntax
- **Bottom Drawer = Deep Navigation**: Click nested variables to drill down with session-based editing

### Example Usage

Conditional variable `{{color-option}}` with spawns `{{option-blue}}` (content: "blue") and `{{option-green}}` (content: "green").

String: "My favorite color is `{{color-option}}`"
- If option-blue selected â†’ "My favorite color is blue"
- If option-green selected â†’ "My favorite color is green"

### Key Features

- **Every String is a Variable**: Automatic variable creation with user-defined or auto-generated 6-character hash
- **Variable Embedding**: Recursive `{{variableHash}}` references with circular protection
- **Conditionals**: Convert strings to directories containing multiple variations (spawns)
- **Spawn Selection**: Users select which spawn variable displays for each conditional
- **Controlling Conditions**: Spawn variables can auto-select based on other spawn selections
- **Session-Based Editing**: Edit multiple related variables in one session, save all on close
- **Mini-Nav System**: Visual hierarchy showing parents ("Used in"), current variable, and children with click-to-navigate
- **Canvas Display Control**: Hide embedded strings, toggle variable hashes, plaintext mode
- **Conditions Sidebar**: Conditional variables managed in left sidebar with radio button spawn selection
- **Real-time Variable Detection**: Pending variables detected as you type `{{newVariable}}`
- **Organization Registry**: Publish finalized strings to a central registry (behind feature flag)
- **User Settings**: Settings page with Account and AI Features tabs
- **OpenAI Integration**: API key management, image-to-text extraction, style guide generation
- **Focus Mode**: Deep-dive view for individual strings (behind feature flag)

---

## Architecture

### Frontend (Next.js 14)
- **Location**: `/frontend/`
- **Framework**: Next.js 14 with App Router, Tailwind CSS, ShadCN/UI
- **State**: React useState/useEffect, cookie-based auth
- **Pattern**: Null-safe operations (`project?.strings`)
- **Development Server**: `npm run dev` (from frontend directory)

### Backend (Django)
- **Location**: `/backend/`  
- **Framework**: Django with DRF, SQLite, session auth
- **Pattern**: Comprehensive validation with meaningful errors
- **Development Server**: 
  ```bash
  source backend/env/bin/activate
  python backend/manage.py runserver
  ```

---

## Data Models

### Core Models

1. **Project**: Container for all content (name, description, user)

2. **String**: The core "file" model - every string is automatically a variable
   - **Fields**: content, project, variable_hash, is_conditional, is_conditional_container, controlled_by_spawn_id, is_published
   - **Variable Hash**: Primary identifier - user-defined (e.g., "welcome-message") or auto-generated 6-character hash
   - **Validation**: Alphanumeric with hyphens, no spaces, max 50 characters
   - **Conditional Variables**: Strings with `is_conditional_container=true` that hold spawn variables
   - **Spawn Variables**: Individual variations within a conditional
   - **Controlled By Spawn**: Optional ForeignKey linking to a controlling spawn variable

3. **Dimension/DimensionValue**: Legacy models retained in database for compatibility but not actively used

### Key Relationships
- Strings reference other strings via `{{variableHash}}` embedding
- Conditional variables contain spawn variables (multiple string variations)
- Spawn selection determines which content displays for conditional variables
- Controlling spawn relationships enable cascading auto-selection
- Circular reference protection prevents infinite loops

---

## User Interface

### Layout (Three Panels)

**Left - Conditions Sidebar (360px)**:
- Conditional variables with their spawn options
- Radio button selection for spawn variables
- Lock icon (ğŸ”’) for controlled/auto-selected spawns
- Edit icons on hover for each conditional and spawn
- Overflow menu with "Add New Spawn" option

**Center - Main Canvas**:
- String variables only (conditionals excluded)
- Optional variable hash display beneath each card
- Canvas Settings button opens settings drawer
- New String button for creating variables
- Global search filters both sidebar and canvas

**Bottom - Edit Drawer (fixed to viewport)**:
- Session-based editing for strings and conditionals
- Mini-nav showing variable relationships
- Three tabs: Content, Conditions, Advanced
- Save/Cancel buttons persist all session changes

### Canvas Settings

**Display Mode Section**:
- **Plaintext Mode**: Show resolved content without styling
- **Show Variables**: Display variable hashes as badges  
- **Hide Embedded Strings**: Hide strings used as variables or spawns
- **Show Variable Hashes**: Display hash beneath each string card

**Conditions Sidebar Section**:
- **Hide Controlled Variables**: Hide spawns that have controlling conditions set

### Bottom Drawer System

**Session-Based Architecture**:
- `useSessionDrawer` hook manages drawer state
- `useEditSession` hook manages multi-variable editing sessions
- `stringOperations.ts` contains save logic
- All changes saved together when drawer closes

**Drawer Layout**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  New/Edit string [String|Cond]   [Mini-nav tiles]          [Copy] [X]  â”‚ â† Header
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â—‹ Content   â”‚                                                           â”‚
â”‚ â—‹ Conditionsâ”‚           Tab content area                                â”‚ â† Main
â”‚ â—‹ Advanced  â”‚                                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                       [Cancel] [Save]   â”‚ â† Footer
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Mini-Nav (Header Center)**:
- **Used in**: Parent variables that embed or spawn the current one
- **Active**: Current variable being edited (larger, centered)
- **Children**: "Spawn variables" (for conditionals) or "Embedded variables" (for strings)
- Click any tile to navigate to that variable within the session
- Color-coded: Teal for strings, Orange for conditionals, Purple for pending
- Pending variables show sparkle (âœ¨) icon

**Content Tab**:
- Variable Type toggle: String or Conditional
- **String Mode**: Content textarea, embedded variable search
- **Conditional Mode**: "Include hide option" toggle, "Add Spawn" button, spawn list

**Conditions Tab**:
- **For spawn variables**: Controlling Condition selector
  - Enable/disable toggle
  - Search-select dropdown listing spawns from other conditionals
  - When controller spawn is selected, this spawn auto-selects
- **For all variables**: List of parent conditional variables

**Advanced Tab**:
- Variable Hash input (editable identifier)
- Shows reference format preview: `{{variableHash}}`
- Delete button in danger zone

### Spawn Management

**Add/Remove Spawns**:
- "Add Spawn" button creates temporary spawn in session
- "Add New Spawn" option in conditional overflow menu
- Overflow menu on each spawn for removal

**Include Hide Option**:
- Toggle next to "Add Spawn" button
- When enabled, adds "Hidden" as selectable option in conditions sidebar
- Selecting "Hidden" removes conditional's content from output

**Controlling Conditions**:
- Spawn variables can be linked to a controller spawn
- When controller is selected, controlled spawn auto-selects
- Controller selection done via search-select in Conditions tab
- Lock icon indicates controlled spawns in sidebar

### Edit Mode Quick-Add Buttons

When bottom drawer is open, ghost-styled "+" buttons appear on:
- String cards in canvas
- Conditional headers in sidebar

**Behavior**:
- Hidden on the variable currently being edited (prevents self-reference)
- If editing string: Embeds `{{variableHash}}` in content
- If editing conditional: Adds variable as spawn
- Toast notifications confirm actions

---

## API Endpoints

### Authentication
- `POST /api/auth/login/` - Login
- `POST /api/auth/logout/` - Logout  
- `POST /api/auth/register/` - Register
- `GET /api/auth/me/` - Current user

### Projects
- `GET /api/projects/` - List projects
- `POST /api/projects/` - Create project
- `GET /api/projects/{id}/` - Get project with all data
- `PATCH /api/projects/{id}/` - Update project
- `DELETE /api/projects/{id}/` - Delete project
- `POST /api/projects/{id}/duplicate/` - Duplicate project

### Strings
- `POST /api/strings/` - Create string
- `PATCH /api/strings/{id}/` - Update string
- `DELETE /api/strings/{id}/` - Delete string
- `POST /api/strings/{id}/duplicate/` - Duplicate string

**String Payload**:
```json
{
  "content": "String content here",
  "variable_hash": "welcome-message",
  "is_conditional": false,
  "is_conditional_container": false,
  "controlled_by_spawn_id": null,
  "is_published": false,
  "project": 1
}
```

### AI Features
- `GET/POST /api/settings/openai/` - OpenAI API key management
- `POST /api/settings/openai/test/` - Test connection
- `POST /api/ai/extract-text/` - Image-to-text extraction
- `POST /api/ai/style-guide/` - Generate style guide from registry

---

## Key Implementation Patterns

### State Management
```javascript
// Null-safe data access
const strings = project?.strings || [];

// Conditional spawn selection (direct variable names)
const [selectedConditionalSpawns, setSelectedConditionalSpawns] = useState<{
  [conditionalVariableName: string]: string | null
}>({});

// Session-based drawer
const mainDrawer = useSessionDrawer({
  project,
  onSuccess: () => fetchProject()
});
```

### Conditional Variable Resolution
```javascript
const selectedSpawnName = selectedConditionalSpawns[conditionalName];

if (selectedSpawnName && selectedSpawnName !== "Hidden") {
  const spawnVariable = project?.strings?.find((str: any) =>
    str.effective_variable_name === selectedSpawnName ||
    str.variable_hash === selectedSpawnName
  );
  
  if (spawnVariable) {
    const spawnContent = processConditionalVariables(spawnVariable.content || '');
    processedContent = processedContent.replace(regex, spawnContent);
  }
}
```

### Controlling Spawn Relationships
```javascript
const getControllingSpawnMap = () => {
  const controllerToControlled = new Map<number, number[]>();
  const controlledToController = new Map<number, number>();
  
  project.strings.forEach((str: any) => {
    if (str.controlled_by_spawn_id) {
      controlledToController.set(str.id, str.controlled_by_spawn_id);
      if (!controllerToControlled.has(str.controlled_by_spawn_id)) {
        controllerToControlled.set(str.controlled_by_spawn_id, []);
      }
      controllerToControlled.get(str.controlled_by_spawn_id)!.push(str.id);
    }
  });
  
  return { controllerToControlled, controlledToController };
};
```

---

## File Structure

```
frontend/src/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ (dashboard)/
â”‚   â”‚   â”œâ”€â”€ projects/[id]/page.tsx      # Main project page
â”‚   â”‚   â”œâ”€â”€ registry/page.tsx           # Registry page
â”‚   â”‚   â””â”€â”€ settings/page.tsx           # User settings
â”‚   â””â”€â”€ style-guide/page.tsx            # Style reference page
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ StringEditDrawer.tsx            # Legacy drawer + VariableSearchSelect
â”‚   â”œâ”€â”€ StringTile.tsx                  # Reusable string card component
â”‚   â”œâ”€â”€ ImageToTextModal.tsx            # Image upload for text extraction
â”‚   â”œâ”€â”€ StyleGuideModal.tsx             # AI style guide generation
â”‚   â””â”€â”€ header.tsx                      # App header with breadcrumbs
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ useSessionDrawer.ts             # Bottom drawer state adapter
â”‚   â””â”€â”€ useEditSession.ts               # Multi-variable session management
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ stringOperations.ts             # Save logic for strings/conditionals
â”‚   â”œâ”€â”€ featureFlags.ts                 # Feature flag configuration
â”‚   â””â”€â”€ HeaderContext.tsx               # Context for header breadcrumbs
â””â”€â”€ styles/
    â””â”€â”€ embedded-variables.scss         # Centralized variable styling
```

### Key Files

- **`page.tsx`**: Main project UI with canvas, sidebar, and bottom drawer
- **`useSessionDrawer.ts`**: Adapter between useEditSession and drawer interface
- **`useEditSession.ts`**: Core session management for multi-variable editing
- **`stringOperations.ts`**: API calls for saving strings and conditionals
- **`featureFlags.ts`**: Centralized feature flag control (FEATURES.REGISTRY)
- **`StringTile.tsx`**: Reusable card component for strings
- **`VariableSearchSelect`**: Exported from StringEditDrawer for search/select UI

---

## Styling System

### Logo
- Font: Courgette (Google Fonts)

### Color Variables (CSS/SCSS)
```scss
$string-var-color: teal;           // String variable accents
$conditional-var-color: orange;    // Conditional variable accents
$pending-var-color: mediumpurple;  // Pending/new variable accents
```

### Embedded Variable Classes
- `.embedded-var-string-{0-4}` - Nested string styling with progressive tinting
- `.embedded-var-conditional-{0-4}` - Nested conditional styling
- Uses `mix()` function for solid hover colors (no transparency)

### Text Styles
- **Description Text**: `text-sm text-muted-foreground` - Used for hashes, previews, helper text
- Reference `/style-guide` page for complete style documentation

---

## Feature Flags

Located in `frontend/src/lib/featureFlags.ts`:

```typescript
export const FEATURES = {
  REGISTRY: false,  // Registry, Publishing tab, Focus Mode
};
```

When `FEATURES.REGISTRY` is false:
- "View Registry" button hidden on homepage
- "Publishing" tab hidden in drawer
- "Focus mode" option hidden in overflow menus

---

## Development Workflow

### Git Operations
- Do NOT commit or push unless explicitly requested
- User controls commit timing and messages

### Development Servers
**Auto-Start**: `.vscode/tasks.json` starts both servers on workspace open

**Manual Start**:
- Backend: `cd backend && source env/bin/activate && python manage.py runserver`
- Frontend: `cd frontend && npm run dev`

### Style Guide Page
- **URL**: `http://localhost:3000/style-guide`
- Reference for all text styles used in the app

---

## Implementation Guidelines

### String Variables
- Every string is automatically a variable
- Variable hash is the sole identifier (no separate display name)
- Canvas shows string variables only (conditionals in sidebar)

### Variable Embedding
- Use `{{variableHash}}` syntax
- Max 10 levels depth with visited set tracking
- Process with current spawn selections
- Validate against circular references

### Session-Based Editing
- All related variables edited in one session
- Changes tracked with `isDirty` flag
- Save all on drawer close
- Navigate between variables via mini-nav

### Error Handling
- Null safety: Use `project?.strings` patterns
- Graceful degradation: Fallbacks for missing data
- User feedback: Toast notifications for actions and errors

---

**CORE PRINCIPLE**: This is a file system for text content. Every string is a file, conditionals are directories, and the bottom drawer with session-based editing enables seamless navigation throughout the hierarchy. Maintain this analogy for intuitive user experience.
